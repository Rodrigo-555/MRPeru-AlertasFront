<div class="main-container">
  <div class="content">
    <h1>PRÓXIMO SERVICIO</h1>

    <!-- Filtros -->
    <section class="filtros-servicio">
      <div class="search-container">
        <div class="search-group">
          <img src="assets/img/iconoSearch.png" alt="Buscar" class="input-search-icon">
          <input 
            type="text" 
            class="form-control custom-search" 
            placeholder="Busque por cliente, referencia, local o serie"
            [(ngModel)]="busquedaTexto"
            (input)="filtrarPorTexto()">
        </div>

        <div class="form-group">
          <label for="fechaInicio">Desde:</label>
          <input
            id="fechaInicio"
            type="date"
            class="form-control"
            [(ngModel)]="fechaInicio"
            (change)="filtrarPorFechas()">
        
          <label for="fechaFin">Hasta:</label>
          <input
            id="fechaFin"
            type="date"
            class="form-control"
            [(ngModel)]="fechaFin"
            (change)="filtrarPorFechas()">
        
          <button class="btn btn-primary" type="button" (click)="filtrarPorFechas()">
            <i class="fas fa-filter"></i> Filtrar
          </button>
        </div>

        <div class="filtro">
          <label for="categoriaCliente">Categoría Clientes:</label>
          <select id="categoriaCliente" [(ngModel)]="categoriaClienteSeleccionada" (change)="filtrarEquipos()" class="form-control">
            <option [ngValue]="null" disabled selected>Seleccione una categoría</option>
            <option value="Clientes con Servicios Regulares">Servicios Regulares</option>
            <option value="Clientes con Servicios No-Regulares">Servicios No-Regulares</option>
            <option value="Clientes con Servicios Antiguos-Recientes">Servicios Antiguos-Recientes</option>
            <option value="Clientes con Servicios Antiguos">Servicios Antiguos</option>
            <option value="Clientes sin servicios">Sin servicios</option>
            <option value="No Es Cliente">No Es Cliente</option>
          </select>
        </div>

        <div class="export-button-container">
          <button class="btn btn-success" (click)="exportarAExcel()">
            <i class="fas fa-file-excel"></i> Exportar a Excel
          </button>
        </div>
      </div>
    </section>

    <!-- Tabla de Equipos -->
    <section class="table-container">
      <div class="table-scroll">
        <table class="table" *ngIf="equiposFiltrados.length > 0; else emptyTable">
          <thead>
            <tr>
              <th (click)="ordenarPor('Cliente')">
                Cliente <i class="sort-icon" [ngClass]="getSortIcon('Cliente')"></i>
              </th>
              <th (click)="ordenarPor('Email')">
                Email <i class="sort-icon" [ngClass]="getSortIcon('Email')"></i>
              </th>
              <th (click)="ordenarPor('Local')">
                Local <i class="sort-icon" [ngClass]="getSortIcon('Local')"></i>
              </th>
              <th (click)="ordenarPor('referencia')">
                Referencia <i class="sort-icon" [ngClass]="getSortIcon('referencia')"></i>
              </th>
              <th (click)="ordenarPor('serie')">
                Serie <i class="sort-icon" [ngClass]="getSortIcon('serie')"></i>
              </th>
              <th (click)="ordenarPor('modelo')">
                Modelo <i class="sort-icon" [ngClass]="getSortIcon('modelo')"></i>
              </th>
              <th (click)="ordenarPor('tipoEquipo')">
                Tipo de Equipo <i class="sort-icon" [ngClass]="getSortIcon('tipoEquipo')"></i>
              </th>
              <th (click)="ordenarPor('estado')">
                Estado <i class="sort-icon" [ngClass]="getSortIcon('estado')"></i>
              </th>
              <th (click)="ordenarPor('estadoMantenimiento')">
                Mantenimiento <i class="sort-icon" [ngClass]="getSortIcon('estadoMantenimiento')"></i>
              </th>
              <th (click)="ordenarPor('fechaProximoServicio')">
                Fecha Próximo Servicio <i class="sort-icon" [ngClass]="getSortIcon('fechaProximoServicio')"></i>
              </th>
              <th class="accion-column">Enviar Notificación</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let equipo of equiposFiltrados | slice:(paginaActual-1)*itemsPorPagina:paginaActual*itemsPorPagina; trackBy: trackByEquipo">
              <td>{{ equipo.cliente }}</td>
              <td>{{ equipo.email }}</td>
              <td>{{ equipo.planta }}</td>
              <td>{{ equipo.referencia }}</td>
              <td>{{ equipo.serie }}</td>
              <td>{{ equipo.modelo }}</td>
              <td>{{ equipo.tipoEquipo }}</td>
              <td>
                <span class="estado-badge" [ngClass]="getBadgeClass(equipo.estado)">
                  {{ getEstadoLabel(equipo.estado) }}
                </span>
              </td>
              <td>
                <span class="mantenimiento-badge" [ngClass]="getMantenimientoBadgeClass(equipo.estadoMantenimiento)">
                  {{ getMantenimientoLabel(equipo.estadoMantenimiento) }}
                </span>
              </td>
              <td [class.proxima-fecha]="esFechaProxima(equipo.fechaProximoServicio)">
                {{ equipo.fechaProximoServicio | date: 'dd/MM/yyyy' }}
              </td>
              <td class="accion-column">
                <button class="btn-enviar-notificacion" 
                        [disabled]="!tieneEmailValido(equipo)"
                        (click)="enviarNotificacionIndividual(equipo)" 
                        title="Enviar notificación a este equipo">
                  <i class="fas fa-bell"></i>
                </button>
              </td>
            </tr>
          </tbody>
        </table>
        

        <div class="acciones-notificacion" *ngIf="equiposSeleccionados.length > 0">
          <div class="equipos-seleccionados">
            <span class="badge-seleccion">{{ equiposSeleccionados.length }}</span> equipos seleccionados
          </div>
          <button class="btn btn-primary btn-notificacion" (click)="enviarNotificacionesMultiples()">
            <i class="fas fa-paper-plane"></i> Enviar Notificaciones ({{ equiposSeleccionados.length }})
          </button>
        </div>

        <!-- Estado de envío de notificaciones -->
        <div class="loading-notificacion" *ngIf="enviandoNotificaciones">
          <div class="spinner"></div>
          <p>Enviando notificaciones, por favor espere...</p>
        </div>

        <!-- Mensaje de resultado -->
        <div class="mensaje-resultado" *ngIf="mensajeResultado" [ngClass]="mensajeResultado.tipo">
          {{ mensajeResultado.mensaje }}
        </div>

        <!-- Mensaje si no hay datos -->
        <ng-template #emptyTable>
          <div class="empty-table">
            <p>Seleccione una categoría de clientes para visualizar los equipos.</p>
          </div>
        </ng-template>
      </div>

      <!-- Contenedor de paginación -->
      <section class="pagination-container" *ngIf="equiposFiltrados.length > 0">
        <!-- Información de paginación -->
        <div class="pagination-info">
          <div class="showing-records">
            <strong>Mostrando:</strong> {{ ((paginaActual-1) * itemsPorPagina) + 1 }} - 
            {{ paginaActual * itemsPorPagina > equiposFiltrados.length ? equiposFiltrados.length : paginaActual * itemsPorPagina }} 
            de {{ equiposFiltrados.length }} registros
          </div>
          <div *ngIf="totalPaginas > 1" class="total-pages">
            <strong>Página {{ paginaActual }} de {{ totalPaginas }}</strong>
          </div>
        </div>
      
        <!-- Paginación mejorada -->
        <nav class="pagination" *ngIf="equiposFiltrados.length > itemsPorPagina">
          <span class="pagination-label">Páginas:</span>
          
          <button class="page-button page-navigation" [disabled]="paginaActual === 1" (click)="cambiarPagina(1)" title="Primera página">
            «
          </button>
          
          <button class="page-button page-navigation" [disabled]="paginaActual === 1" (click)="cambiarPagina(paginaActual - 1)" title="Página anterior">
            ‹
          </button>
          
          <ng-container *ngIf="totalPaginas <= 7">
            <button 
              class="page-button" 
              *ngFor="let pagina of getPaginas()" 
              [class.active]="pagina === paginaActual"
              (click)="cambiarPagina(pagina)">
              {{ pagina }}
            </button>
          </ng-container>
          
          <ng-container *ngIf="totalPaginas > 7">
            <!-- Primera página siempre visible -->
            <button 
              class="page-button" 
              [class.active]="1 === paginaActual"
              (click)="cambiarPagina(1)"
              *ngIf="paginaActual > 3">
              1
            </button>
            
            <!-- Indicador de páginas omitidas -->
            <button class="page-button" *ngIf="paginaActual > 4" disabled>...</button>
            
            <!-- Páginas alrededor de la actual -->
            <button 
              class="page-button" 
              *ngFor="let pagina of getPaginasVisibles()" 
              [class.active]="pagina === paginaActual"
              (click)="cambiarPagina(pagina)">
              {{ pagina }}
            </button>
            
            <!-- Indicador de páginas omitidas -->
            <button class="page-button" *ngIf="paginaActual < totalPaginas - 3" disabled>...</button>
            
            <!-- Última página siempre visible -->
            <button 
              class="page-button" 
              [class.active]="totalPaginas === paginaActual"
              (click)="cambiarPagina(totalPaginas)"
              *ngIf="paginaActual < totalPaginas - 2">
              {{ totalPaginas }}
            </button>
          </ng-container>
          
          <button class="page-button page-navigation" [disabled]="paginaActual === totalPaginas" (click)="cambiarPagina(paginaActual + 1)" title="Página siguiente">
            ›
          </button>
          
          <button class="page-button page-navigation" [disabled]="paginaActual === totalPaginas" (click)="cambiarPagina(totalPaginas)" title="Última página">
            »
          </button>
        </nav>
      </section>
    </section>
  </div>
</div>