<div class="main-container">
  <div class="content">
    <h1>NOTIFICACIONES DE SERVICIOS</h1>
    
    <div class="two-column-layout">
      <!-- Columna Izquierda: Árbol de Clientes -->
      <div class="left-column">
        <div class="search-container">
          <div class="search-group">
            <img src="assets/img/iconoSearch.png" alt="Buscar" class="input-search-icon">
            <input 
              type="text" 
              class="form-control custom-search" 
              placeholder="Buscar cliente o RUC..."
              [(ngModel)]="busquedaClientes"
              (keyup)="manejarCambioEnBusqueda($event)"
              (keyup.enter)="buscarYNavegar()"
              aria-label="Buscar clientes">
            <!-- Botón para limpiar la búsqueda -->
            <button 
              *ngIf="busquedaClientes"
              class="btn-clear" 
              (click)="limpiarBusqueda()" 
              title="Limpiar búsqueda">
              <i class="fas fa-times"></i>
            </button>
            <button 
              class="btn-search" 
              (click)="buscarYNavegar()" 
              title="Buscar y navegar al cliente">
              <i class="fas fa-search"></i>
            </button>
          </div>
        </div>
        
        <!-- Sección Árbol de Clientes -->
        <div class="content-tree" [class.search-active]="busquedaClientes">
          <div class="tree-header">
            <span>Clientes</span>
            <div>
              <span class="expand-all" (click)="expandirTodo()">Expandir</span> | 
              <span class="collapse-all" (click)="colapsarTodo()">Colapsar</span>
            </div>
          </div>
          <div class="tree">
            <ng-container *ngFor="let category of clienteCategories | slice:0:15; trackBy: trackByCategoryFn">
              <details #categoryDetails class="category-details">
                <summary>
                  <div class="summary-content">
                    <img src="assets/img/folder-icon.png" alt="Carpeta" class="icono-arbol">
                    {{ category.title }} 
                    <span class="cliente-count">{{ category.clientes?.length || 0 }}</span>
                  </div>
                </summary>
                <div class="cliente-container">
                  <ng-container *ngIf="category.clientes?.length > 0; else noClientes">
                    <ng-container *ngFor="let cliente of category.clientes; trackBy: trackByCliente">
                      <details #clienteDetails class="cliente-details">
                        <summary (click)="$event.stopPropagation(); seleccionarCliente($event, cliente.nombre)">
                          <div class="summary-content">
                            <img src="assets/img/user-icon.png" alt="Cliente" class="icono-arbol">
                            {{ cliente.nombre }}
                            <span class="local-count">{{ cliente.locales?.length || 0 }}</span>
                          </div>
                        </summary>
                        <div class="local-container">
                          <ng-container *ngFor="let local of cliente.locales; trackBy: trackByPlanta">
                            <details class="local-details" 
                                  [class.local-selected]="localSeleccionado === local.local && clienteSeleccionado === cliente.nombre">
                            <summary (click)="clickLocalSummary($event, cliente.nombre, local.local)">
                              <div class="summary-content">
                                <img src="assets/img/building-icon.png" alt="Local" class="icono-arbol">
                                {{ local.local }}
                              </div>
                            </summary>
                            <!-- Contenido igual que antes -->
                            <div class="equipos-container">
                              <!-- Cuando hay equipos -->
                              <ng-container *ngIf="EquiposPlantas.length > 0">
                                <div 
                                  *ngFor="let equipo of EquiposPlantas" 
                                  class="equipo-item"
                                  [class.equipo-selected]="equipoSeleccionado === equipo"
                                  (click)="$event.stopPropagation(); seleccionarEquipo(equipo)">
                                  <img src="assets/img/machine-icon.png" alt="Equipo" class="icono-arbol">
                                  {{ equipo }}
                                </div>
                              </ng-container>
                              
                              <!-- Cuando está cargando -->
                              <div class="cargando-equipos" *ngIf="cargandoEquiposLocal">
                                <div class="spinner-container">
                                  <div class="spinner"></div>
                                </div>
                                <span>Cargando equipos...</span>
                              </div>
                              
                              <!-- Cuando no hay equipos (no está cargando y el array está vacío) -->
                              <div class="cargando-equipos" *ngIf="!cargandoEquiposLocal && EquiposPlantas.length === 0">
                                <img alt="Sin equipos" class="icono-arbol">
                                <span>No hay equipos para este local</span>
                              </div>
                            </div>
                          </details>
                          </ng-container>
                        </div>
                      </details>
                    </ng-container>
                  </ng-container>
                  <ng-template #noClientes>
                    <div class="no-results">No hay clientes para mostrar</div>
                  </ng-template>
                </div>
              </details>
            </ng-container>
            <div *ngIf="clienteCategories.length === 0" class="no-results">
              Cargando clientes...
            </div>
          </div>
        </div>
      </div>
      
      <!-- Sección Tabla de Equipos Mejorada -->
      <div class="right-column">

        <!-- Información del cliente seleccionado -->
        <h2 *ngIf="clienteSeleccionado">
          {{ clienteSeleccionado }} <span *ngIf="clienteRucSeleccionado" class="client-ruc">RUC: {{ clienteRucSeleccionado }}</span>
        </h2>
      
        <!-- Información de estadísticas cuando se muestran todos los equipos -->
        <div *ngIf="clienteSeleccionado && mostrandoTodosEquipos" class="client-info">
          <h3>Total de Equipos del Cliente: {{ totalEquiposCliente }}</h3>
          <h4>Equipos mostrados: {{ equiposFiltrados.length }}</h4>
        </div>

        <!-- Información del local seleccionado -->
        <div *ngIf="localSeleccionado" class="local-info">
          <h3>Local: {{ localSeleccionado }}</h3>
          <h4>Total de Equipos: {{ EquiposPlantas.length }}</h4>
        </div>
      
        <!-- Mensaje de ayuda -->
        <div *ngIf="!localSeleccionado && clienteSeleccionado && !mostrandoTodosEquipos" class="client-help-text">
          <p>Seleccione un local en el árbol para ver sus equipos.</p>
        </div>

        <div class="equipment-detail-info" *ngIf="mostrandoDetalleEquipo">
          <div class="detail-header">
            <h4>
              <i class="fas fa-info-circle"></i> 
              Detalles del equipo: {{ equipoSeleccionado }}
            </h4>
            <button class="btn-volver" (click)="volverAListaEquipos()">
              <i class="fas fa-arrow-left"></i> Volver a la lista
            </button>
          </div>
        </div>
        
        <!-- Sección de Filtros y Búsqueda -->
        <div class="search-container">
          <div class="form-group">
            <label for="estadoSelect">Estado:</label>
            <select
              id="estadoSelect"
              class="form-select custom-select"
              [(ngModel)]="estadoSeleccionado"
              (change)="filtrarEquipos()">
              <option value="">Todos</option>
              <option value="A">Activo 🟢</option>
              <option value="I">Inactivo 🔴</option>
            </select>
          </div>
          <div class="form-group">
            <label for="mantenimientoSelect">Mantenimiento:</label>
            <select
              id="mantenimientoSelect"
              class="form-select custom-select"
              [(ngModel)]="estadoMantenimientoSeleccionado"
              (change)="filtrarEquipos()">
              <option value="">Todos</option>
              <option value="V">No requiere servicio 🟢</option>
              <option value="A">Requiere servicio ⚠️</option>
            </select>
          </div>
          <div class="search-group">
            <img src="assets/img/iconoSearch.png" alt="Buscar" class="input-search-icon">
            <img src="assets/img/iconoSearch.png" alt="Buscar" class="input-search-icon">
            <input 
              type="text" 
              class="form-control custom-search" 
              placeholder="Buscar por contacto, referencia, modelo o serie..."
              [(ngModel)]="busquedaContacto"
              (input)="filtrarEquipos()">
          </div>
        </div>

        <!-- Sección Tabla de Equipos con scroll horizontal -->
        <div class="table-container">
          <div class="table-wrapper">
            <table class="table" *ngIf="equiposFiltrados.length > 0; else emptyTable">
              <thead>
                <tr>
                  <!-- Columna 'Local' visible solo cuando se muestra todos los equipos del cliente -->
                  <th *ngIf="mostrandoTodosEquipos" (click)="ordenarPor('local')">
                    Local <i class="sort-icon" [ngClass]="getSortIcon('local')"></i>
                  </th>
                  <th (click)="ordenarPor('contacto')">
                    Contacto <i class="sort-icon" [ngClass]="getSortIcon('contacto')"></i>
                  </th>
                  <th (click)="ordenarPor('email')">
                    Email <i class="sort-icon" [ngClass]="getSortIcon('email')"></i>
                  </th>
                  <th (click)="ordenarPor('fechaProximoServicio')">
                    Próximo Servicio <i class="sort-icon" [ngClass]="getSortIcon('fechaProximoServicio')"></i>
                  </th>
                  <th (click)="ordenarPor('referencia')">
                    Referencia <i class="sort-icon" [ngClass]="getSortIcon('referencia')"></i>
                  </th>
                  <th (click)="ordenarPor('modelo')">
                    Modelo <i class="sort-icon" [ngClass]="getSortIcon('modelo')"></i>
                  </th>
                  <th (click)="ordenarPor('serie')">
                    Serie <i class="sort-icon" [ngClass]="getSortIcon('serie')"></i>
                  </th>
                  <th (click)="ordenarPor('horometro')">
                    Horometro <i class="sort-icon" [ngClass]="getSortIcon('horometro')"></i>
                  </th>
                  <th (click)="ordenarPor('tipoEquipo')">
                    Tipo de Equipo <i class="sort-icon" [ngClass]="getSortIcon('tipoEquipo')"></i>
                  </th>
                  <th (click)="ordenarPor('estado')">
                    Estado <i class="sort-icon" [ngClass]="getSortIcon('estado')"></i>
                  </th>
                  <th (click)="ordenarPor('estadoMantenimiento')">
                    Mantenimiento <i class="sort-icon" [ngClass]="getSortIcon('estadoMantenimiento')"></i>
                  </th>
                </tr>
              </thead>
              <tbody>
                <ng-container *ngFor="let equipo of equiposPaginados; trackBy: trackByEquipo">
                  <tr>
                    <!-- Columna 'Local' visible solo cuando se muestra todos los equipos del cliente -->
                    <td *ngIf="mostrandoTodosEquipos">{{ equipo.local }}</td>
                    <td>{{ equipo.contacto }}</td>
                    <td>
                      <a [href]="'mailto:' + equipo.email" class="email-link">{{ equipo.email }}</a>
                    </td>
                    <td [class.proxima-fecha]="esFechaProxima(equipo.fechaProximoServicio)">
                      {{ equipo.fechaProximoServicio ? (equipo.fechaProximoServicio | date: 'dd/MM/yyyy') : "Sin servicio programado" }}
                    </td>
                    <td>{{ equipo.referencia }}</td>
                    <td>{{ equipo.modelo }}</td>
                    <td>{{ equipo.serie }}</td>
                    <td>{{ equipo.horometroUltimoServicio }}</td>
                    <td>{{ equipo.tipoEquipo }}</td>
                    <td>
                      <span class="estado-badge" [ngClass]="getBadgeClass(equipo.estado)">
                        {{ getEstadoLabel(equipo.estado) }}
                      </span>
                    </td>
                    <td>
                      <span class="mantenimiento-badge" [ngClass]="getMantenimientoBadgeClass(equipo.estadoMantenimiento)">
                        {{ getMantenimientoLabel(equipo.estadoMantenimiento) }}
                      </span>
                    </td>
                  </tr>
                </ng-container>
              </tbody>
            </table>
            
            <ng-template #emptyTable>
              <div class="empty-table">
                <p>No se encontraron registros que coincidan con los criterios de búsqueda.</p>
              </div>
            </ng-template>
          </div>
        </div>
        
        <!-- Paginación separada del contenedor de la tabla -->
        <div class="pagination-container" *ngIf="equiposFiltrados.length > 0">
          <div class="page-info">
            Mostrando {{ ((paginaActual-1)*itemsPorPagina)+1 }} - {{ paginaActual*itemsPorPagina > equiposFiltrados.length ? equiposFiltrados.length : paginaActual*itemsPorPagina }} de {{ equiposFiltrados.length }} registros
          </div>
          <div class="pagination" *ngIf="equiposFiltrados.length > itemsPorPagina">
            <button class="page-button" [disabled]="paginaActual === 1" (click)="cambiarPagina(1)" title="Primera página">
              «
            </button>
            <button class="page-button" [disabled]="paginaActual === 1" (click)="cambiarPagina(paginaActual - 1)" title="Página anterior">
              ‹
            </button>
            <button class="page-button" *ngFor="let pagina of getPaginas()" 
                    [class.active]="pagina === paginaActual"
                    (click)="cambiarPagina(pagina)">
              {{ pagina }}
            </button>
            <button class="page-button" [disabled]="paginaActual === totalPaginas" (click)="cambiarPagina(paginaActual + 1)" title="Página siguiente">
              ›
            </button>
            <button class="page-button" [disabled]="paginaActual === totalPaginas" (click)="cambiarPagina(totalPaginas)" title="Última página">
              »
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>